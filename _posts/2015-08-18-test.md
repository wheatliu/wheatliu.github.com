---
layout: blog
title: 测试
---

#solrcloud迁移
## 概览
- [ ] check server list
- [ ] set setenv.sh
- [ ] upload configuration files to zookeeper
- [ ] check logfile path
- [ ] check solr host ip
- [ ] check vip
- [ ] tomcat logrotate
- [ ] restart tomcat servers 
- [ ] create collection
- [ ] test

## 步骤
1. 查看servers list

    search:

    |hostname|ip address|
    |:------:|:--------:|
    |search1|192.168.1.203|
    |search2|192.168.1.213|
    |search3|192.168.1.169|
    |search4|192.168.1.179|

    zookeeper:

    ``` bash
    192.168.1.7:2181,192.168.1.8:2181,192.168.1.27:2181
    ```

2. 确认setenv.sh

    ``` bash
    JAVA_OPTS="$JAVA_OPTS -server -Xms512m -Xmx1024m -XX:PermSize=256M -XX:MaxNewSize=512m -XX:MaxPermSize=256m -DzkHost=192.168.1.7:2181,192.168.1.8:2181,192.168.1.27:2181/solr"
    ```

3. 上传配置文件到zookeeper

    ``` bash
    java -classpath .:/opt/solr/solr_app/WEB-INF/lib/* org.apache.solr.cloud.ZkCLI -cmd upconfig -zkhost 192.168.1.7:2181,192.168.1.8:2181,192.168.1.27:2181/solr -confdir /opt/solr/solr_home/album/conf/ -confname album
    java -classpath .:/opt/solr/solr_app/WEB-INF/lib/* org.apache.solr.cloud.ZkCLI -cmd upconfig -zkhost 192.168.1.7:2181,192.168.1.8:2181,192.168.1.27:2181/solr -confdir /opt/solr/solr_home/application/conf/ -confname application
    java -classpath .:/opt/solr/solr_app/WEB-INF/lib/* org.apache.solr.cloud.ZkCLI -cmd upconfig -zkhost 192.168.1.7:2181,192.168.1.8:2181,192.168.1.27:2181/solr -confdir /opt/solr/solr_home/book/conf/ -confname book
    ```

4. 日志文件路径

    ``` bash
    /var/log/solr
    sed -i 's#/opt#/var/log#g' /opt/tomcat7/lib/log4j.properties
    ```

5. 确认solr配置选项 host

    ``` bash
    /opt/solr/solr_home/solr.xml
    ```

6. 确认vip

    ``` bash
    ifconfig | awk -F'[: ]+' '/lo:/ {getline;print $4}'
    ```

7. tomcat logrotate

    ``` bash
    cat << EOF >> /etc/logrotate.d/tomcat
    /opt/tomcat7/logs/catalina.out{
    daily
    rotate 5
    compress
    notifempty
    missingok
    }
    ```

8. 服务重启

    ``` bash
    /etc/init.d/tomcat restart
    ```

9. 创建collection

    ``` bash
    curl 'http://127.0.0.1:8080/solr/admin/collections?action=DELETE&name=album'
    curl 'http://127.0.0.1:8080/solr/admin/collections?action=DELETE&name=book'
    curl 'http://127.0.0.1:8080/solr/admin/collections?action=DELETE&name=application'
    curl 'http://127.0.0.1:8080/solr/admin/collections?action=CREATE&name=album&numShards=2&replicationFactor=2'
    curl 'http://127.0.0.1:8080/solr/admin/collections?action=CREATE&name=book&numShards=2&replicationFactor=2'
    curl 'http://127.0.0.1:8080/solr/admin/collections?action=CREATE&name=application&numShards=2&replicationFactor=2'
    ```


10. 测试

